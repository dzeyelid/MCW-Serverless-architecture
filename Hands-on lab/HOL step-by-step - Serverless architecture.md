![Microsoft Cloud Workshops](https://github.com/Microsoft/MCW-Template-Cloud-Workshop/raw/master/Media/ms-cloud-workshop.png 'Microsoft Cloud Workshops')

<div class="MCWHeader1">
?????????????
</div>

<div class="MCWHeader2">
????????????? ??????? ??????????
</div>

<div class="MCWHeader3">
June 2019
</div>

Information in this document, including URL and other Internet Web site references, is subject to change without notice. Unless otherwise noted, the example companies, organizations, products, domain names, e-mail addresses, logos, people, places, and events depicted herein are fictitious, and no association with any real company, organization, product, domain name, e-mail address, logo, person, place or event is intended or should be inferred. Complying with all applicable copyright laws is the responsibility of the user. Without limiting the rights under copyright, no part of this document may be reproduced, stored in or introduced into a retrieval system, or transmitted in any form or by any means (electronic, mechanical, photocopying, recording, or otherwise), or for any purpose, without the express written permission of Microsoft Corporation.

Microsoft may have patents, patent applications, trademarks, copyrights, or other intellectual property rights covering subject matter in this document. Except as expressly provided in any written license agreement from Microsoft, the furnishing of this document does not give you any license to these patents, trademarks, copyrights, or other intellectual property.

The names of manufacturers, products, or URLs are provided for informational purposes only and Microsoft makes no representations and warranties, either expressed, implied, or statutory, regarding these manufacturers or the use of the products with any Microsoft technologies. The inclusion of a manufacturer or product does not imply endorsement of Microsoft of the manufacturer or product. Links may be provided to third party sites. Such sites are not under the control of Microsoft and Microsoft is not responsible for the contents of any linked site or any link contained in a linked site, or any changes or updates to such sites. Microsoft is not responsible for webcasting or any other form of transmission received from any linked site. Microsoft is providing these links to you only as a convenience, and the inclusion of any link does not imply endorsement of Microsoft of the site or the products contained therein.

Â© 2019 Microsoft Corporation. All rights reserved.

Microsoft and the trademarks listed at <https://www.microsoft.com/legal/intellectualproperty/Trademarks/Usage/General.aspx> are trademarks of the Microsoft group of companies. All other trademarks are property of their respective owners.

**?????**

<!-- TOC -->

- [????????????? ??????? ??????????](#?????????????-???????-??????????)
  - [??????????](#??????????)
  - [??](#??)
  - [??????????????](#??????????????)
  - [????](#????)
  - [?? 1: Azure ???????????????????????????](#??-1-Azure-???????????????????????????)
    - [????](#????)
    - [??? 1: ?????????????](#???-1-?????????????)
    - [??? 2: Function Apps???](#???-2-function-apps???)
    - [??? 3: Event Grid ???????](#???-3-event-grid-???????)
    - [??? 4: Azure Cosmos DB ????????](#???-4-Azure-Cosmos-DB-????????)
    - [??? 5: Computer Vision API service ???](#???-5-Computer-Vision-API-service-???)
  - [?? 2: ?????????????????????????](#??-2-?????????????????????????)
    - [????](#????-1)
    - [??? 1: ?????????????](#???-1-?????????????)
    - [??? 2: ???????](#???-2-???????)
    - [??? 3: Visual Studio ?? Function App ???](#???-3-Visual-Studio-??-Function-App-???)
  - [?? 3: Azure ??????????](#??-3-Azure-??????????)
    - [????](#????-2)
    - [??? 1: Cosmos DB ??????????????????????](#???-1-Cosmos-DB-??????????????????????)
    - [??? 2: SavePlateData ??? Event Grid ?????????????](#???-2-SavePlateData-???-Event-Grid-?????????????)
    - [??? 3: SavePlateData ??? Cosmos DB ????????????????](#???-3-SavePlateData-???-Cosmos-DB-????????????????)
    - [??? 4: Cosmos DB ??????????????????](#???-4-Cosmos-DB-??????????????????)
    - [??? 5: QueuePlateForManualCheckup ??? Event Grid ????????????](#???-5-QueuePlateForManualCheckup-???-Event-Grid-????????????)
    - [??? 6: QueuePlateForManualCheckup ??? Cosmos DB ????????????????](#???-6-QueuePlateForManualCheckup-???-Cosmos-DB-????????????????)
    - [??? 7: Event Grid ???????????????](#???-7-Event-Grid-???????????????)
  - [?? 4: Application Insights ? Function App ???](#??-4-Application-Insights-?-Function-App-???)
    - [????](#????-3)
    - [??? 1: Application Insights ?????????](#???-1-Application-Insights-?????????)
    - [??? 2: Function Apps ? Application Insights ????](#???-2-Function-Apps-?-Application-Insights-????)
    - [??? 3: ??????????????????????????](#???-3-??????????????????????????)
    - [??? 4: Function App ??????????????????](#???-4-Function-App-??????????????????)
  - [?? 5: Cosmos DB ???????](#??-5-Cosmos-DB-???????)
    - [????](#????-4)
    - [??? 1: Azure Cosmos DB ???????????????](#???-1-Azure-Cosmos-DB-???????????????)
  - [?? 6: ???????????????????](#??-6-???????????????????)
    - [????](#????-5)
    - [??? 1: Logic App ???](#???-1-Logic-App-???)
  - [?? 7: Function App ????????????](#??-7-Function-App-????????????)
    - [????](#????-6)
    - [??? 1: GitHub ????????](#???-1-GitHub-????????)
    - [??? 2: Visual Studio ? GitHub ??????????](#???-2-Visual-Studio-?-GitHub-??????????)
    - [??? 3: Function App ? GitHub ???????????????](#???-3-Function-App-?-GitHub-???????????????)
    - [??? 4: ExportLicensePlates ??????? GitHub ????????????????](#???-4-ExportLicensePlates-???????-GitHub-????-???????????)
  - [?? 8: ???????????????????](#exercise-8-???????????????????)
    - [??? 1: Logic App ???](#???-1-Logic-App-???)
    - [??? 2: ????????? CSV ???????](#???-2-?????????-CSV-???????)
  - [?????????????](#?????????????)
    - [??? 1: ???????????](#???-1-???????????)
    - [??? 2: GitHub ????????](#???-2-GitHub-????????)

<!-- /TOC -->

# ????????????? ??????? ??????????

## ??????????

????????????Microsoft Azure Functions?Azure Cosmos DB?Event Grid ?????????????????????????????????????????????????????????????????????????????????? Microsoft Azure????????????????????????????????????????????????????????????????????????????????????????????????

????????????????????????????????????????????????????????????????????????

## ??

???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

????????????? CSV ??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

## ??????????????

????????????????????????????????????????????????????????????????????????????????????

![](media/image2.png '?????????????')

???????????????????? blob ??????????????????????????????????????? **Azure Function** ??????**Cognitive Services Computer Vision API OCR** ????????????????????????????????????????????????????????????? `savePlateData` ??????????? Event Grid ??????????????????????????`queuePlateForManualCheckup` ????????????????????????? **Azure Cosmos DB** ???????????????????????????????????????????????**Logic App** ? 15 ??? Azure Function ? HTTP ??????????Cosmos DB ????????????????CSV ??????? blob ?????????????????????????????????????????????????**Application Insights** ???? Azure Functions ?????????????????????????????????????????????????????????????????????

## ????

- Microsoft Azure ?????????
- ?????????? PC ???????? (**?????????????**):
  - [Visual Studio Community 2019 ??](https://www.visualstudio.com/vs/)
  - [Visual Studio 2019 Azure ????????](https://docs.microsoft.com/azure/azure-functions/functions-develop-vs#prerequisites)
  - [.NET Framework ????? 4.7 ??](https://www.microsoft.com/net/download/windows)
- Office 365 ??????[???](https://portal.office.com/Signup/MainSignup15.aspx?Dap=False&QuoteId=79a957e-ad59-4d82-b787-a46955934171&ali=1)???????
- [GitHub ?????](https://github.com) ?????????? 

## ?? 1: Azure ???????????????????????????

**????**: 30 ?

???????????????Azure ?????????????????????????????????????????????????????

?????????????????? blob ????????????? CSV ????????? 2 ???????????????? 2 ?? Function App ??????Visual Studio ? Azure ?????????????? Event Grid ?????????Cosmos DB ? 2 ??????????????????????????? OCR ????? Cognitive Services Computer Vision API service ??????????

### ????

|   **??**  | **???**  |
| --- | :-- |
| ????? ???????? | https://docs.microsoft.com/ja-jp/azure/storage/common/storage-quickstart-create-account?toc=%2Fazure%2Fstorage%2Fblobs%2Ftoc.json%23create-a-storage-account&tabs=azure-portal |
| Azure ???? ?? Function App ????? | https://docs.microsoft.com/ja-jp/azure/azure-functions/functions-create-function-app-portal |
| Azure Event Grid ???  | https://docs.microsoft.com/ja-jp/azure/event-grid/concepts  |
| Azure Cosmos ?????????? | https://docs.microsoft.com/ja-jp/azure/cosmos-db/how-to-manage-database-account |

### ??? 1: ?????????????

1.  [Azure ????](http://portal.azure.com) ??????

2.  **+ ???????** ?? **?????** ?????**??????????** ??????

    ![](media/new-storage-account.png 'Azure ????')

3.  **?????????????** ????????

    a. **????????**: **ServerlessArchitecture** ?????????????????

    b. **???????????**: **tollboothstorage** ?????????????????????????????

    c. **??**: ????????

    d. **???????**: **Standard**

    e. **????????**: **StorageV2 (?? v2)**

    f. **????????**: **??????????? (LRS)**

    g. **?????**: **???**

    ![](media/image12.png '?????????? ????')

4.  **???????** ???????**??**?

5.  ???????? **ServerlessArchitecture** ?????????????? **??????????** ????

    ![](media/image14.png 'ServerlessArchitecture')

6.  **???? ??** ?? **key1** ? **?????** ?????

    ![](media/image15.png '?????????? ????')

7.  ?????????????

8.  **Blob Service** ????? **BLOB** ????**+ ?????** ??????????????????**??** ? **images**?????????**?????? (????????????)** ????? **OK** ??????

    ![](media/image16.png '????????? ????')

9.  ????? **export** ????????

    ![](media/new-container-export.png '????????? ????')

### ??? 2: Function Apps???

1. [Azure ????](http://portal.azure.com) ??????

2.  **+ ???????**??? **func** ????**Function App** ????

    ![](media/image17.png 'Azure ????')

3.  **??** ??????

4.  **?????** ?????????:

    a. **????????**: **ServerlessArchitecture** ????

    b. **??????**: **TollBoothFunctionApp** ???????????????????

    c. **?????? ????**: **.NET Core** ????

    d. **??**: ????????**??? ????** ??????

    e. **????? ?????**: ????????????????

    f. **???????? ????**: **Windows** ????

    g. **???**: **???????** ????**??:??>** ??????

    h. **Application Insights ??????**: **???** ???????????

5.  **?????**???????**??** ??????

    ![](media/new-functionapp-net.png 'Function App ????')

6.  2 ??? Function App ???

7.  **?????** ?????????:

    a. **????????**: **ServerlessArchitecture** ????

    b. **??????**: **TollBoothEvents** ???????????????????

    c. **?????? ????**: **Node.js** ????

    d. **??**: ????????**??? ????** ??????

    e. **????? ?????**: ????????????????

    f. **???????? ????**: **Windows** ????

    g. **???**: **???????** ????**??:??>** ??????

    h. **Application Insights ??????**: **???** ???????????     

8.  **?????**???????**??** ??????

    ![](media/new-functionapp-javascript.png 'Function App ????')

### ??? 3: Event Grid ???????

1. [Azure ????](http://portal.azure.com) ??????

2.  **+ ???????**?? **event grid** ????**Event Grid Topic** ????

    ![](media/image19.png 'Azure ????')

3.  **??** ??????

4.  **???????** ????????:

    a. **??**: **TollboothEventGrid** ????

    b. **????????**: **ServerlessArchitecture** ????

    c. **??**: ????????

    d. **???? ????**: **???? ???? ????** ????

    ![](media/image20.png '??????????')

5.  **??** ??????

6.  ????????????????????

7.  **??** ??? **???? ???????** ???????????????

    ![](media/image21.png 'TollBoothTopic ????')

8.  ???? **???? ??** ????

9.  **Key 1** ?????????????????

    ![](media/image22.png 'TollBoothTopic - ?????? ????')

### ??? 4: Azure Cosmos DB ????????

1. [Azure ????](http://portal.azure.com) ??????

2.  **+ ???????** ??  **??????** ??? **Azure Cosmos DB** ??????

    ![](media/image23.png 'Azure ????')

3.  **Azure Cosmos DB ????????** ??????:

    a. **????????**: **ServerlessArchitecture** ????

    b. **??????**: **tollboothdb** ??????????????????

    c. **API**: **?? (SQL)** ????

    d. **??**: ????????

    e. **goe ???**: **??** ????

    f. **??? ?????????**: **??** ????

    ![](media/image24.png 'Azure Cosmos DB ????')

4.  **?????**???????**??** ??????

5.  ???????????????????

6.  **Containers** ??????? **??** ???????**?????????** ??????

    ![](media/image25.png 'Tollbooths ????')

7.  **Add Container** ??????????:

    a. **Database id**: **LicensePlates** ????

    b. **Provision database throughput**: ????????

    c. **Container id**: **Processed** ????

    d. **Partition key**: **/licensePlateText** ????

    e. **Throughput**: **5000** ????

    ![](media/cosmosdb-add-processed-collection.png '??????????')

8)  **OK** ??????

9)  **New Container** ??????????????????

10) **Add Container** ??????????:

    a. **Database id**: `Use existing` ?? **LicensePlates** ????

    b. **Container id**: **NeedsManualReview** ???

    c. **Partition key**: **/fileName** ????

    d. **Throughput**: **5000** ????

    ![](media/cosmosdb-add-manualreview-collection.png '????????????')

11) **OK** ??????

12) **??**?**??**??????

13) **????/??????**????? **URI** ? **????? ??** ??????????????

    ![](media/image28.png 'tollbooth - ??????')

### ??? 5: Computer Vision API service ???

1. [Azure ????](http://portal.azure.com) ??????

2.  **+ ???????** ?? **computer vision** ????**Computer Vision** ????

    ![]](media/image29.png 'Azure ????')

3.  **??** ??????

4.  **??** ????????:

    a. **??**: **tollboothvisionINIT** ???????????????????

    b. **??**: ????????

    c. **?????**: **S1** ????

    d. **????????**: **ServerlessArchitecture** ????

    ![](media/image30.png '??????')

5.  **??** ??????

6.  ???????????????????

7.  **???? ????** ??? **Key1** ? **???????**????????????????? 

    ![](media/image31.png 'TollboothOCR ????')

## ?? 2: ?????????????????????????

**????**: 45 ?

Visual Studio ? Azure Function ???????????????????????????????Azure ?????????
?????? starter ???????????? TollBooths ?????????????????????????Azure ???????

### ????

|   **??**  | **???**  |
| --- | :-- |
| Azure Functions Core Tools ??? | https://docs.microsoft.com/ja-jp/azure/azure-functions/functions-run-local |

### ??? 1: ?????????????

????????Azure ??????????????????????????Visual Studio ????????????

1.  [Azure ????](http://portal.azure.com) ??????

2.  **ServerlessArchitecture** ?????????? **TollBoothFunctionApp** ??? Azure Function ????

    ![](media/image33.png 'ServerlessArchtecture ????????')

3.  **??**??**??**??????

    ![](media/image34.png 'TollBoothFunctionApp ????')

4.  **??????????** ? **+ ?????????????**???????????????????:

|   |   |
| --- | :--: |
| **??** | **?** |
| computerVisionApiUrl     | ?? 1 ????? Computer Vision ? URL ? vision/v2.0/ocr ??????? |
| computerVisionApiKey     | ?? 1 ????? Computer Vision ? ?? |
| eventGridTopicEndpoint   | ?? 1 ????? Event Grid ????????????  |
| eventGridTopicKey        | ?? 1 ????? Event Grid ??????? |
| cosmosDBEndPointUrl      | ?? 1 ????? Cosmos DB ???????? |
| cosmosDBAuthorizationKey | ?? 1 ????? Cosmos DB ?????? ?? |
| cosmosDBDatabaseId       | LicensePlates |
| cosmosDBCollectionId     | Processed |
| exportCsvContainerName   | export |
| blobStorageConnection    | ?? 1 ????????????????????? |

![](media/image35.png '??????????')

> **??**: computerVisionApiUrl ? vision/v2.0/ocr ????????????????????????

5.  **??**??????

    ![](media/image36.png '??????')

6.  (?????) ???????????????????????????

    a. local.settings.json ?????????????.

    b. `AzureWebJobsStorage` ? `AzureWebJobsDashboard` ??? 4 ????????????????

### ??? 2: ???????

starter ??????????????????TODO ??????????????? TODO ? ProcessImage ??????FindLicensePlateText ????Computer Vision API ??????SendToEventGrid.cs ???? Event Grid ???????????????????

> **??**: Nuget ???????????????????????????????????? Nuget ????????????????????????????????????????????????????

1.  **TollBooth** ??????? (/hands-on-lab/starts/TollBooth/TollBooth.sln) Visual Studio ?????????????????????

2.  **??**?? **?????**??????

    ![](media/image37.png 'Visual Studio ????')

3.  TODO ?????????1 ???????????????

    ![](media/image38.png 'TODO ???')

4.  **ProcessImage.cs** ?????Run ????? `FunctionName` ???????? `ProcessImage` ????????????????? Event Grid ?? HTTP ??????????????????? Event Grid ??????? URL ???????????????????????????(???????)???? blob ???????????Event Grid ?????????????????????????????????????????

5.  TODO 1 ?????????????

```csharp
// **TODO 1: Set the licensePlateText value by awaiting a new FindLicensePlateText.GetLicensePlate method.**

licensePlateText = await new FindLicensePlateText(log, _client).GetLicensePlate(licensePlateImage);
```

6.  **FindLicensePlateText.cs** ????????????? Computer Vision API ????OCR ????????????????????? [Polly](https://github.com/App-vNext/Polly) ?????????? (Resiliency Pattern) ????????Polly ????????? .NET ????????????????????????????? Computer Vision API ???????????????????????????????????????????????

7.  TODO 2 ?????????????

```csharp
// TODO 2: Populate the below two variables with the correct AppSettings properties.
var uriBase = Environment.GetEnvironmentVariable("computerVisionApiUrl");
var apiKey = Environment.GetEnvironmentVariable("computerVisionApiKey");
```

8.  **SendToEventGrid.cs** ??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

9.  TODO 3?TODO 4 ?????????????

```csharp
// TODO 3: Modify send method to include the proper eventType name value for saving plate data.
await Send("savePlateData", "TollBooth/CustomerService", data);

// TODO 4: Modify send method to include the proper eventType name value for queuing plate for manual review.
await Send("queuePlateForManualCheckup", "TollBooth/CustomerService", data);
```

> **??**: ??? TODO ?????

### ??? 3: Visual Studio ?? Function App ???

???????????? Function App ? Visual Studio ?? Azure ?????????

1.  ???????????????? **TollBooth** ??????????

1.  **TollBooth** ?????????????? **??**??????

    ![](media/image39.png '???????????????')

1.  **Azure Function ?????????** ?????**????????** ??????????**??**??????

    ![](media/vs-publish-function.png '???????')

> **??**: ??????????????Visual Studio ??????????????

1.  **?????????**?????**ServerlessArchitecture** ????????????**TollBoothFunctionApp** ??????????????

    ![](media/image41.png 'App Service ????')

1.  **OK** ??????

    > **??**: Azure ? Function App ??????????????????????????????????

1.  "?????????" ????????????????

1.  [Azure ????](http://portal.azure.com) ??????

1.  **ServerlessArchitecture** ???????????? Function App ????

1.  **??**??????????????????????????

    ![](media/image42.png 'TollBoothFunctionApp ????')

1.  ?? Event Grid ?????????????????**ProcessImage** ??????? **Event Grid ????????????** ??????

    ![](media/processimage-add-eg-sub.png 'ProcessImage ??')

1.  **???? ????????????** ????????:

    a. **??**: **processimagesub** ????

    b. **???? ????**: **???? ???? ????** ????

    c. **???????**: **Storage Accounts** ????

    d. **?????????**? **Subscription** ? **ServerlessArchitecture** ????

    e. ????????????????

    f. **?????????????**: **Blob Created** ????

    g. ????????????????

1. **??**??????

    ![](media/processimage-eg-sub.png)

## ?? 3: Azure ??????????

**????**: 45 ?

???????Azure ???? ? Node.js ?? Azure Function ???? 2 ????????????? Event Grid ?????????????????????? Cosmos DB ???????

### ????

| **??** | **???** |
| --- | :-- |
| Azure ???? ???????????? | https://docs.microsoft.com/ja-jp/azure/azure-functions/functions-create-first-azure-function |
| Azure Functions ? Azure Cosmos DB ????????????????? | https://docs.microsoft.com/ja-jp/azure/azure-functions/functions-integrate-store-unstructured-data-cosmosdb?tabs=csharp |

### ??? 1: Cosmos DB ??????????????????????

??????? Event Grid ?????????????????????? Cosmos DB ????? Node.js ?????????

1.  [Azure ????](http://portal.azure.com) ??????

2.  **ServerlessArchitecture** ?????? **TollBoothEvent** ??? Function App ??????

3.  **+ ?????** ??????

    ![](media/image43.png 'TollBoothEvents ????')

4.  **?????** ????? **??**??????

    ![](media/new-function-in-portal.png 'Azure Functions for JavaScript ????')

5.  **??????????**??????**????????????**??????

    ![](media/new-function-more-templates.png 'Azure Functions for JavaScript ????')

6.  **event grid** ??????**Azure Event Grid trigger** ????

    ![](media/new-function-event-grid-trigger-template.png 'Template ????')

    a. ???????????????????**??????** ??????

    ![](media/install-function-extension.png  '????????????')

    b. ??????????**??**??????

7.  **??** ? `SavePlateData` ????? **??**??????

    ![](media/new-function-saveplatedata.png '???????????')

8.  ???????????:

```javascript
module.exports = function(context, eventGridEvent) {
  context.log(typeof eventGridEvent);
  context.log(eventGridEvent);

  context.bindings.outputDocument = {
    fileName: eventGridEvent.data['fileName'],
    licensePlateText: eventGridEvent.data['licensePlateText'],
    timeStamp: eventGridEvent.data['timeStamp'],
    exported: false
  };

  context.done();
};
```

9.  **??**??????

### ??? 2: SavePlateData ??? Event Grid ?????????????

????????SavePlateData ??? Event Grid ????????????????????? savePlateData ???????????????????????????

1.  SavePlateData ?????? **Event Grid ????????????**??????

    ![](media/saveplatedata-add-eg-sub.png 'SavePlateData ????')

2.  **???? ????????????** ???????????:

    a. **??**: **saveplatedatasub** ????

    b. **???? ????**: **???? ???? ????** ????

    c. **???????**: **Event Grid Topics** ????

    d. **?????????**? **Subscription** ? **ServerlessArchitecture** ????

    e. ????????????

    f. **?????????????**: ???????????????

    g. ????????????????
    
3.  **??**??????

    ![](media/saveplatedata-eg-sub.png)

### ??? 3: SavePlateData ??? Cosmos DB ????????????????

??????? SavePlateData ??? Azure Cosmos DB ???????????????????????????????????

1.  **SavePlateData** ???????? **??**??????

2.  ??????? **+ ?????** ?? **Azure Cosmos DB** ???????**??**?????

    ![](media/image48.png 'SavePlateData ????')

3.  **Azure Cosmos DB output** ??????`Azure Cosmos DB ???????`??**??**??????

    ![](media/image49.png '?????')

    > **??**: `??????????????????`?????????????**??????**?????????????????????

    ![](media/cosmos-extension-install.png '?????')

4.  ???????? Cosmos DB ?????????

5.  ?????????????:

    a. **???????**: **LicensePlates**

    b. **???????**: **Processed**

    ![](media/saveplatedata-cosmos-integration.png 'Azure Cosmos DB ??????')

6.  **??**??????

    > **??**: ???????????????????????????

### ??? 4: Cosmos DB ??????????????????

?????????????????????? Event Grid ????????????????????

1.  **??** ??????**+ ?????**??????

    ![](media/image43.png 'TollBoothEvents ????')

2.  **event grid** ??????**Azure Event Grid trigger** ????

    a. ?????????????????????**??????** ??????

    b. ????**??**??????

    ![](media/image44.png 'Event grid trigger')

3.  **?????**??????? **QueuePlateForManualCheckup** ??????**??**??????

    ![](media/image51.png '?????')

4. ?????????????**??** ??????

```javascript
module.exports = async function(context, eventGridEvent) {
  context.log(typeof eventGridEvent);
  context.log(eventGridEvent);

  context.bindings.outputDocument = {
    fileName: eventGridEvent.data['fileName'],
    licensePlateText: '',
    timeStamp: eventGridEvent.data['timeStamp'],
    resolved: false
  };

  context.done();
};
```

### ??? 5: QueuePlateForManualCheckup ??? Event Grid ????????????

??????? QueuePlateForManualCheckup ? Event Grid ????????????????????? queuePlateForManualCheckup ??????????????????????????

1.  QueuePlateForManualCheckup ??? **Event Grid ????????????**??????

    ![](media/manualcheckup-add-eg-sub.png 'QueuePlateForManualCheckup ????')

2. **???? ????????????** ????????:

    a. **??**: **queueplateFormanualcheckupsub** ????

    b. **???? ????**: **???? ???? ????**????

    c. **Topic Types**: **Event Grid Topics** ????

    d. **Subscription** ? **Resource Group**:  ????????????? **ServerlessArchitecture** ????

    e. ????????????

    f. **?????????????**: ???????????????

    g. ????????????????

3.  **??**??????

    ![](media/manualcheckup-eg-sub.png)

### ??? 6: QueuePlateForManualCheckup ??? Cosmos DB ????????????????

??????? QueuePlateForManualCheckup ??? Azure Cosmos DB ???????????????????NeedsManualReview ???????????????????????

1.  QueuePlateForManualCheckup ??????? **??**??????

2.  ??????? **+ ?????** ?? **Azure Cosmos DB** ???????**??**?????

    ![](media/image54.png?'?????')

3.  **Azure Cosmos DB output** ??????????????:
   
    a. **???????**: **LicensePlates**

    b. **???????**: **NeedsManualReview**

    c. **Azure Cosmos DB ???????**: ????????????

    ![](media/manualcheckup-cosmos-integration.png 'Azure Cosmos DB output form')

4.  **??**??????

### ??? 7: Event Grid ???????????????

????????????????? Event Grid ?????????????????????????????????????????????????????????????????????????????????????

1.  [Azure ????](http://portal.azure.com) ??????

2.  **ServerlessArchitecture** ?????????? Event Grid ????????

3.  **??**??????????????????? **saveplatedatasub** ????

    ![](media/image56.png)

4.  **?????**????????

5.  **??????????**????????**savePlateData** ????

    ![](media/event-grid-saveplatedata.png '??????????')

6.  **??**??????

7.  ??? **queueplateformanualcheckupsub** ?????????????

    ![On the Event Grid Topic overview ????, select the queueplateformanualcheckupsub Event Grid subscription.](media/image58.png)

8. **?????**????????

9. **??????????**????????**queuePlateForManualCheckup** ????

10. **??**??????

## ?? 4: Application Insights ? Function App ???

**????**: 45 ?

Application Insights ? Azure Function ???????????????????????????????? Azure Function ? Application Insights ????????????????????????

### ????

| **??** | **???** |
| --- | :-- |
| Azure Functions ????? | <https://docs.microsoft.com/ja-jp/azure/azure-functions/functions-monitoring> |
| Live Metrics Stream:1 ????????????? | <https://docs.microsoft.com/ja-jp/azure/azure-monitor/app/live-stream> |

### ??? 1: Application Insights ?????????

1. [Azure ????](http://portal.azure.com) ??????

2.  **+ ???????**?? **application insights** ?????**Application Insights** ????

    ![](media/image60.png 'Azure ????')

3.  **??**?????????

4.  On the **Application Insights** ????, specify the following configuration options:

    a. **???? ????**: **ServerlessArchitecture** ????

    b. **??**: **TollboothMonitor** ???????????????????

    c. **??**: ????????

    ![](media/image61.png 'Application Insights ????')

5.  **???????**???????**??**??????

### ??? 2: Function Apps ? Application Insights ????

???????????? Function Apps ???? Application Insights ??????????????????????

1.  **ServerlessArchitecture** ?????????????? Application Insights ????

2.  **??**???**??????????????**????

    ![](media/image62.png 'TollBoothMonitor ????')

3.  **TollBoothFunctionApp** ???? Function App ????

4.  **??**?**??**??????

5.  **+ ?????????????**????????**APPINSIGHTS_INSTRUMENTATIONKEY** ??????????????????????????????????

    ![](media/image63.png 'TollBoothFunctionApp ????')

6.  **OK** ??????

7.  ?????**??**??????

    ![](media/image36.png '??????')

8.  ?? 1 ?? Function App ??????????

### ??? 3: ??????????????????????????

???????????? Application Insights ????????????????????????????????????

1.  **TollBoothFunctionApp** ????? Function App ????

2.  **??**??? **Application Insights** ??????

    > **??**: ?????????????????????????

    ![](media/image64.png 'TollBoothFunctionApp ????')

3.  ?????? **??? ?????? ?????** ??????

    ![](media/image65.png 'TollBoothMonitor ????')

4.  ????????????????????????Visual Studio ????

5.  ????????????????? **UploadImages** ????

    ![](media/image66.png '???????????????')

6.  **App.config** ????

7.  **blobStorageConnection** ?????????????????????

    ![](media/image67.png 'App.config ??')

8.  ??????

9.  **UploadImages** ??????????????**????** | **????????????**????

    ![](media/image68.png '???????????????')

10. ????????????**1** ????? **ENTER** ??????????????????????????

    ![](media/image69.png '?????????')

11. ??????????????????????????????????????????????????????????????????

    ![](media/image70.png '??????????????')

12. ?????????????????????????? `UploadImages` ???????????????????? 2 ??????? 1000 ???????????????

    ![](media/image71.png '?????????')

13. ????????????????????????????????????????????????????? 2 ????????????????????????????????????1 ???????????? ~500ms ?????

    ![](media/image72.png '??????????????')

14. ?????????????????????????????????????????????????

### ??? 4: Function App ??????????????????

??????? Computer Vision API ??????? F0 ?????OCR ? 1 ?? 10 ????????????????? UploadImages ???? 1000 ?????????FindLicensePlateText.MakeOCRRequest ???????????????????????????????????????????? Function App ?????????????????????????????????????????????????

1.  **ServerlessArchitecture** ?????????? **Computer Vision API ????**????

2.  **?????** ??????**S1 Standard** ?? **F0 Free** ?????**??**??????

    > **??**: ??? **F0** ???????? Cognitive Service ???????????

    ![](media/image73.png '?????????')

3.  **UploadImages** ????????????????????????? **2** ????

    ![](media/image71.png '?????????')

4.  ????????????????????????????????????????????????????????????????????????????????????????????Computer Vision API ?? HTTP ????? 429 ????????????????????????????????????

    > **Note**: ????????????Function App ?????

    ![](media/image74.png '??????????????')

5.  ???????????UploadImages ????

6.  **Computer Vision API** ?????????? **S1 Standard** ????

## ?? 5: Cosmos DB ???????

**????**: 15 ?

?????? Azure Cosmos DB ?????????? Azure ????????????

### ????

| **??** | **???** |
| --- | :-- |
| Azure Cosmos DB ??? | <https://docs.microsoft.com/ja-jp/azure/cosmos-db/introduction> |

### ??? 1: Azure Cosmos DB ???????????????

1.  **ServerlessArchitecture** ?????????? **Azure Cosmos DB** ????

2.  **??? ????????** ?????????

    ![](media/image75.png 'Tollbooth - ???????????????')

3.  **Processed** ??????????? **Items** ????????? JSON ????????????????

4.  ???????? 1 ??????????? 4 ???????? Function App ????????????? Cosmos DB ????????????

    ![](media/image76.png 'Tollbooth - ???????????????')

5.  **NeedsManualReview** ??????? **Items** ????

6.  ???????? 1 ??????????? 4 ???????? Function App ????????????? Cosmos DB ?????????????? 4 ???????????????? resolved ?????????????????????????????????????????????????

    ![](media/image77.png 'Tollbooth - ???????????????')

7.  **Processed** ?????????????? **New SQL Query** ??????

    ![](media/image78.png 'Tollbooth - ???????????????')

8.  ??????????

```sql
SELECT VALUE COUNT(c.id) FROM c WHERE c.exported = false
```

9.  ?????????????????????????????????????? 309 ???????

    ![](media/cosmos-query-results.png 'Query 1 tab')

## ?? 6: ???????????????????

**????**: 30 ?

?????? Logic App ??????????????????Logic App ??????????ExportLicensePlates ??????????????????????????????

### ????

| **??** | **???** |
| --- | :-- |
| Azure Logic Apps ?? | https://docs.microsoft.com/ja-jp/azure/logic-apps/logic-apps-overview |
| Azure Logic Apps ?? Azure ??????? | https://docs.microsoft.com/ja-jp/azure/logic-apps/logic-apps-azure-functions |

### ??? 1: Logic App ???

1. [Azure ????](http://portal.azure.com) ??????

2.  **+ ???????** ?? **logic app** ?????**Logic App** ????

    ![](media/image80.png 'Azure ????')

3.  **??** ?????????

4.  **Logic App ??** ????????:

    a. **??**: **TollBoothLogic** ????

    b. **????????**: ??? **ServerlessArchitecture** ????

    c. **??**: ????????

    d. **Log Analytics**:  **Off** ????

    ![](media/image81.png 'Create logic app ????')

5.  **??**????????????????????

6.  **Log Apps ?????**????**????**????????

    ![](media/image82.png 'Logic App ?????')

7.  **??**? **15** ?????

8.  **+ ???????** ??????

    ![](media/image83.png 'Logic App ?????')

9.  **Functions** ????? **Azure Functions** ????

    ![](media/image85.png 'Logic App ?????')

10. **TollBoothFunctionApp** ??????????????

    ![](media/image86.png 'Logic App ?????')

11. **ExportLicensePlates** ??????

    ![](media/image87.png 'Logic App ?????')

12. ????????????????????????????????**+ ???????** ??????? **??** ???? ??????? **??**????

    ![](media/logicapp-add-condition.png 'Logic App ?????')

13. **????**?**?????**?????????????**???????**????? **200** ??????

    > **??**: ????? `ExportLicensePlates` ???????? HTTP ?????? 200 ????????????????????????????????????? 200 ????????????????????????????? 204 (NoContent) ????

    ![](media/logicapp-condition.png '???????')

14. ??? 200 ?????????????**true ???**?????????**false ???**?**????????**??????

    ![](media/logicapp-condition-false-add.png '???????')

15. **??????** ??????Office 365 Outlook ?**?????**????

    ![](media/logicapp-send-email.png 'Office 365 Outlook ?????')

16. **?????**????????????

    ![](media/image93.png 'Office 365 Outlook ?????')

17. ???????????????:

    a. **??**: ??????????????

    b. **??**: **??????????????????????**?????

    c. **??**: ??????????`ExportLicensePlates` ?**?????** ?????

    ![](media/image94.png '??????????')

18. Logic Apps ??????**??**??????

19. **??**??????????????????????????? `ExportLicensePlates` ????? Cosmos DB ????? CSV ??? blob ???????????????????????

    ![](media/image95.png 'Logic Apps ?????')

20. ??????????????????????????????????????????????????????????????????????????????????????

    ![](media/image96.png 'Logic Apps ?????')

21. ?????????????????15 ???????????????????**??**??**??**??????

    ![](media/image97.png 'TollBoothLogic ????')

## ?? 7: Function App ????????????

**????**: 40 ?

???????Function App ??????????????????????? GitHub ???????????????????????

### ????

| **??** | **???** |
| --- | :-- |
| ??????????? | https://help.github.com/ja/articles/creating-a-new-repository |
| Azure Functions ????????? | https://docs.microsoft.com/ja-jp/azure/azure-functions/functions-continuous-deployment |

### ??? 1: GitHub ????????

1.  [GitHub](https://github.com) ????????? GitHub ???????????

2.  ????? **+** ?? **New repository** ??????

    ![](media/image98.png 'GitHub')

3.  ????? **Repository name** ????**Public** ????? **Create repository** ??????

    > **??**: **Public** ?????????????????????????????????????????????????????????

    ![](media/image99.png '???????')

4.  **HTTPS git path** ?????

    ![](media/image100.png 'Repository ???')

### ??? 2: Visual Studio ? GitHub ??????????

1.  Visual Studio ? **TollBooth** ??????????

2.  **TollBooth** ????????????????**????????????????**??????

    ![](media/vs-add-to-source-control.png '???????????????')

3.  **??**??????**??? ????????**??????

    ![](media/vs-view-team-explorer.png 'Visual Studio')

4.  ?????????

5.  ????????????**??**??????

    ![](media/vs-sync-button.png '???????????')

6.  **???? ??????????**?? **Git ????????**???????????????????????????**??**??????

    ![](media/image104.png '??????????? - ??')

7.  GitHub ??????????????????????????????????????**TollBooth** ?????????local.settings.json ?????????????????????? .gitignore ??????????????????????????? .gitignore ?????????????????????????????????????

    ![](media/image105.png 'GitHub Repository ???')

### ??? 3: Function App ? GitHub ???????????????

1.  Azure ?????? **TollBoothFunctionApp** ????? Function App ????

2.  **??????????**???**????????**??????

    ![](media/functionapp-deployment-center-link.png 'TollBoothFunctionApp ????')

3.  **GitHub** ?????**??**????????????????????????????????????**??**??????

    ![In the Deployment Center ????, the GitHub icon is selected.](media/functionapp-dc-github.png '???????? ????')

4.  **App Service ????????**??????**??**??????

    ![](media/functionapp-dc-build-provider.png '???????? ????')

5.  ?? GitHub ???????

6.  ???????????????????

    ![](media/functionapp-dc-configure.png '???????? ????')

7.  **??**??????

8.  ???????**??**??????

9.  ??????????????????????????????????????????

### ??? 4: ExportLicensePlates ??????? GitHub ????????????????

1.  Visual Studio ? **TollBooth** ??????????

2.  **??**???**?????**????

    ![](media/image37.png 'Visual Studio View menu')

3.  ????????????????????

4.  **DatabaseMethods.cs** ????

5.  DatabaseMethods.cs ?? TODO ???????????:

```csharp
// TODO 5: Retrieve a List of LicensePlateDataDocument objects from the collectionLink where the exported value is false.
licensePlates = _client.CreateDocumentQuery<LicensePlateDataDocument>(collectionLink,
        new FeedOptions() { EnableCrossPartitionQuery=true,MaxItemCount = 100 })
    .Where(l => l.exported == false)
    .ToList();
// TODO 6: Remove the line below.
```

6.  TODO 6 ?????????????????: 
```csharp
//licensePlates = new List<LicensePlateDataDocument>();.
```
7.  ?????????? **FileMethods.cs** ????

8.  TODO 7 ????????????:

```csharp
// TODO 7: Asyncronously upload the blob from the memory stream.
await blob.UploadFromStreamAsync(stream);
```

9.  ??????

10. **TollBooth** ???????????????**?????** | **????**??????

    ![In Solution Explorer, TollBooth is selected. From its right-click menu, Source Control and Commit are both selected.](media/image101.png '???????????????')

11. ????????????**??**?????????????**????????**??????

    ![](media/image110.png '???????????????')

12. ????????**??**??????????

    ![](media/image103.png '???????????????')

13. **??**??????

    ![](media/image111.png '???????????????')

    ??????????????????????????

14. ????????????????????????????????????????

    ![](media/functionapp-dc-latest.png 'Deployment Center')

## ?? 8: ???????????????????

**????**: 10 ?

?????????????Logic App ??????????????????????????????????????????

### ??? 1: Logic App ???

1.  Azure ?????????????? Logic App ????

2.  **??**?**??**??????

    ![](media/image113.png 'TollBoothLogic ????')

3.  **???????**?? **Recurrence** ?????????????????

    ![](media/image114.png 'TollBoothLogic ????')

4.  **????????** ??????????????????????????????????? **true** ??????????true ???????? CSV ??? blob ??????????????

    ![In Logic App Designer, in the Condition section, under Inputs, true is circled.](media/image115.png 'Logic App Designer ')

### ??? 2: ????????? CSV ???????

1.  **ServerlessArchitecture** ????????????????????? **????? ?????**????

2.  **Blob service** ???**?????**????

    ![.](media/image116.png 'Blob service')

3.  **export** ????????

    ![](media/image117.png 'Export ????')

4.  ????????? CSV ?????????1 ??????**??????**??????
    
    ![](media/blob-download.png 'Blob ?????')

5? CSV ?????????????????

    ![](media/csv.png 'CSV file')

`ExportLicensePlates` ???????????????exported ?????? `true` ??????????????????????????????Cosmos DB ????? SQL ???????????????

## ?????????????

**????**: 10 ?

????????????????????

### ??? 1: ???????????

1.  Azure ?????? **ServerlessArchitecture** ????????????**???? ???????**??????

2.  ?????????????????????????**??**??????.

3.  ??????????????????????????????

### ??? 2: GitHub ????????

1.  [GitHub](https://www.github.com) ???????????????

2.  **Settings** ???????????????? **Delete this repository** ?????????????????????